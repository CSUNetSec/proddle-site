<?php
require_once 'php/vendor/autoload.php';
require_once 'php/login.php';

//parse command line parameters
if (isset($_GET['duration'])) $duration=$_GET['duration'];
else $duration=1;

$timestamp = time() - ($duration * 24 * 60 * 60);

//open driver manager and geoip reader
$manager = new MongoDB\Driver\Manager(
    $mongodbConnectionString,
    [
        'ssl' => TRUE,
        'username' => $mongodbUsername,
        'password' => $mongodbPassword,
        'authSource' => $mongodbAuthSource
    ],
    [
        'ca_file' => $mongodbSslCaCert,
        'pem_file' => $mongodbSslPem
    ]
);
$reader = new GeoIp2\Database\Reader('/usr/local/share/GeoLite2/GeoLite2-City.mmdb');

//query for top flags
echo '{"top_flags":[';
$top_cursor = $manager->executeCommand(
    'tipup',
    new MongoDB\Driver\Command(
        [
            'aggregate' => 'flags',
            'pipeline' => [
                [
                    '$group' => [
                        '_id' => ['domain' => '$domain', 'url' => '$url'],
                        'count' => ['$sum' => 1]
                    ]
                ],
                [
                    '$sort' => ['count' => -1]
                ],
                [
                    '$limit' => 25
                ]
            ]
        ]
    )
);

$top_array = $top_cursor->toArray()[0]->result;
for ($i=0; $i < count($top_array); ++$i) {
    $top_flag = $top_array[$i];
    echo ($i != 0 ? ',' : '') . '{"domain":"' . $top_flag->_id->domain . '","url":"' . $top_flag->_id->url . '","count":' . $top_flag->count . '}';
}

//query for distinct statuses
echo '],"flag_statuses":[';
$status_cursor = $manager->executeCommand(
    'tipup',
    new MongoDB\Driver\Command(
        [
            'aggregate' => 'flags',
            'pipeline' => [
                [
                    '$group' => [
                        '_id' => ['status' => '$status'],
                        'count' => ['$sum' => 1]
                    ]
                ],
                [
                    '$sort' => ['count' => -1]
                ]
            ]
        ]
    )
);

$status_array = $status_cursor->toArray()[0]->result;
for ($i=0; $i < count($status_array); ++$i) {
    $status = $status_array[$i];
    echo ($i != 0 ? ',' : '') . '{"status":"' . $status->_id->status . '","count":' . $status->count . '}';
}

//query for distinct analyzers
echo '],"flag_analyzers":[';
$analyzer_cursor = $manager->executeCommand(
    'tipup',
    new MongoDB\Driver\Command(
        [
            'aggregate' => 'flags',
            'pipeline' => [
                [
                    '$group' => [
                        '_id' => ['analyzer' => '$analyzer'],
                        'count' => ['$sum' => 1]
                    ]
                ],
                [
                    '$sort' => ['count' => -1]
                ]
            ]
        ]
    )
);

$analyzer_array = $analyzer_cursor->toArray()[0]->result;
for ($i=0; $i < count($analyzer_array); ++$i) {
    $analyzer = $analyzer_array[$i];
    echo ($i != 0 ? ',' : '') . '{"analyzer":"' . $analyzer->_id->analyzer . '","count":' . $analyzer->count . '}';
}

//TODO query for flags
echo '],"flags":[';

echo ']}';
?>
